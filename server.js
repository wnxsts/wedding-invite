require("dotenv").config();
const express = require("express");
const { Pool } = require("pg");
const cors = require("cors");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 4000;

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ DATABASE_URL
if (!process.env.DATABASE_URL) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: DATABASE_URL Ð½Ðµ Ð·Ð°Ð´Ð°Ð½!");
    process.exit(1);
}

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº PostgreSQL
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === "production" ? { rejectUnauthorized: false } : false, // SSL Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Render
});

app.use(cors());
app.use(express.json());

// Ð Ð°Ð·Ð´Ð°Ñ‘Ð¼ ÑÑ‚Ð°Ñ‚Ð¸ÐºÑƒ (Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÑÐ°Ð¹Ñ‚)
app.use(express.static(path.join(__dirname, "public")));

// Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
pool.query(`
    CREATE TABLE IF NOT EXISTS guests (
        id SERIAL PRIMARY KEY,
        name TEXT NOT NULL,
        attending TEXT NOT NULL
    );
`).then(() => {
    console.log("âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° guests Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð°/ÑÐ¾Ð·Ð´Ð°Ð½Ð°");
}).catch(err => {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹:", err);
});

// ðŸ“Œ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ð¾ÑÑ‚ÐµÐ¹
app.get("/guests", async (req, res) => {
    try {
        const result = await pool.query("SELECT * FROM guests");
        res.json(result.rows);
    } catch (err) {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð³Ð¾ÑÑ‚ÐµÐ¹:", err);
        res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°" });
    }
});

// ðŸ“Œ Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾ÑÑ‚Ñ
app.post("/submit", async (req, res) => {
    const { name, attending } = req.body;
    if (!name || !attending) {
        return res.status(400).json({ message: "Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ" });
    }
    try {
        await pool.query("INSERT INTO guests (name, attending) VALUES ($1, $2)", [name, attending]);
        res.json({ message: "Ð“Ð¾ÑÑ‚ÑŒ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½!" });
    } catch (err) {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð³Ð¾ÑÑ‚Ñ:", err);
        res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸" });
    }
});

// ðŸ“Œ ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ð¿Ð°Ð´Ð°Ð»)
app.use((err, req, res, next) => {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ°:", err);
    res.status(500).json({ error: "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°" });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
    console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});
